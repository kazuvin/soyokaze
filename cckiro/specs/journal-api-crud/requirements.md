# ジャーナル API CRUD 要件定義書

## 1. 概要

このタスクでは、既存のモノリポ構成のAPIパッケージに対して、ジャーナル（日記）エントリの作成・編集・削除機能を提供するREST APIを実装します。

## 2. 前提条件・制約

### 2.1 技術スタック
- **フレームワーク**: Hono (Cloudflare Workers)
- **データベース**: Cloudflare D1 (SQLite)
- **ORM**: Drizzle ORM
- **バリデーション**: Zod
- **デプロイ環境**: Cloudflare Workers

### 2.2 既存構造との整合性
- `packages/api/` ディレクトリ内の既存パターンに従う
- 既存のエラーハンドリング（AppError階層）を使用
- 既存のレスポンス形式（ApiResponse型）に準拠
- Zodスキーマベースのバリデーションを採用

### 2.3 モバイルアプリとの連携
- モバイルアプリ（`packages/mobile/`）で既に実装されているジャーナル機能との連携
- 将来的なオフライン同期機能への対応（sync-ready architecture）

## 3. 機能要件

### 3.1 ジャーナルエントリの基本属性
- **id**: 一意識別子（自動採番）
- **title**: タイトル（必須、1-200文字）
- **content**: 本文（必須、1文字以上）
- **date**: 日記の対象日（必須、YYYY-MM-DD形式）
- **authorId**: 作成者ID（外部キー、users.id参照）
- **createdAt**: 作成日時（自動設定）
- **updatedAt**: 更新日時（自動更新）

### 3.2 APIエンドポイント仕様

#### 3.2.1 ジャーナル一覧取得
- **エンドポイント**: `GET /journals`
- **機能**: ページネーション対応の一覧取得
- **クエリパラメータ**:
  - `page`: ページ番号（デフォルト: 1）
  - `limit`: 取得件数（デフォルト: 10、最大: 100）
  - `authorId`: 作成者でのフィルタリング（オプション）
  - `date`: 特定日付でのフィルタリング（オプション、YYYY-MM-DD形式）
- **レスポンス**: ジャーナル配列とページネーション情報

#### 3.2.2 ジャーナル詳細取得
- **エンドポイント**: `GET /journals/:id`
- **機能**: 指定IDのジャーナル詳細取得
- **パラメータ**: `id` (数値、必須)
- **レスポンス**: ジャーナル詳細オブジェクト

#### 3.2.3 ジャーナル作成
- **エンドポイント**: `POST /journals`
- **機能**: 新規ジャーナルエントリ作成
- **リクエストボディ**:
  ```json
  {
    "title": "string (1-200文字)",
    "content": "string (1文字以上)",
    "date": "string (YYYY-MM-DD形式)",
    "authorId": "number"
  }
  ```
- **レスポンス**: 作成されたジャーナルオブジェクト

#### 3.2.4 ジャーナル更新
- **エンドポイント**: `PUT /journals/:id`
- **機能**: 既存ジャーナルエントリの更新
- **パラメータ**: `id` (数値、必須)
- **リクエストボディ**:
  ```json
  {
    "title": "string (1-200文字、オプション)",
    "content": "string (1文字以上、オプション)",
    "date": "string (YYYY-MM-DD形式、オプション)"
  }
  ```
- **レスポンス**: 更新されたジャーナルオブジェクト

#### 3.2.5 ジャーナル削除
- **エンドポイント**: `DELETE /journals/:id`
- **機能**: 指定IDのジャーナル削除
- **パラメータ**: `id` (数値、必須)
- **レスポンス**: 削除成功メッセージ

## 4. 非機能要件

### 4.1 セキュリティ
- **認証**: 将来実装予定のFirebase認証に対応する設計
- **認可**: 作成者本人のみがジャーナルを編集・削除可能（将来実装）

### 4.2 パフォーマンス
- **レスポンス時間**: 通常のCRUD操作で200ms以内
- **ページネーション**: 大量データに対応するため必須

### 4.3 エラーハンドリング
- **404エラー**: 存在しないリソースアクセス時
- **400エラー**: バリデーションエラー時
- **500エラー**: サーバー内部エラー時
- 既存のAppError階層を使用した統一的なエラーレスポンス

### 4.4 データ整合性
- **外部キー制約**: authorIdはusers.idに対する有効な参照
- **日付形式**: ISO 8601形式（YYYY-MM-DD）の厳密な検証
- **必須フィールド**: title, content, date, authorIdの必須入力

## 5. データベース要件

### 5.1 journalsテーブル定義
```sql
CREATE TABLE journals (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  date TEXT NOT NULL,
  authorId INTEGER NOT NULL,
  createdAt TEXT DEFAULT CURRENT_TIMESTAMP,
  updatedAt TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (authorId) REFERENCES users(id)
);
```

### 5.2 インデックス
- **authorId**: 作成者による検索最適化
- **date**: 日付による検索最適化
- **複合インデックス**: (authorId, date) 作成者×日付での検索最適化

## 6. テスト要件

### 6.1 単体テスト
- バリデーションスキーマのテスト
- エラーハンドリングのテスト
- CRUDオペレーションのテスト

## 7. 実装範囲

### 7.1 実装対象
- ジャーナルCRUD API（5つのエンドポイント）
- データベーススキーマとマイグレーション
- Zodバリデーションスキーマ
- 既存のAPIパターンに準拠したルート実装

### 7.2 実装対象外（将来実装）
- Firebase認証の統合
- 認可ロジック（所有者チェック）
- リアルタイム同期機能
- モバイルアプリとのオフライン同期

## 8. 成功基準

- [ ] 5つのAPIエンドポイントが正常に動作する
- [ ] 既存のAPIパターンと整合性が取れている
- [ ] Zodスキーマによるバリデーションが適切に機能する
- [ ] エラーハンドリングが統一的に動作する
- [ ] データベース操作が型安全に実行される
- [ ] APIデプロイ（`npm run api:deploy`）が成功する