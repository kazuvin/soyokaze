# 共通 API クライアント生成 要件定義書

## 1. 概要

webやmobileアプリケーションから全てのAPI（journals、users、posts等）を呼び出すためのタイプセーフな共通クライアントライブラリを生成します。既存のスキーマファーストアプローチに従い、Honoアプリケーションの型定義を活用したクライアントサービスを実装します。

## 2. 前提条件・制約

### 2.1 技術スタック
- **APIサーバー**: Hono (Cloudflare Workers)
- **クライアント**: Hono Client (hc)
- **バリデーション**: Zod (既存スキーマ活用)
- **型システム**: TypeScript
- **モノリポ**: npm workspaces

### 2.2 既存システム状況
- **OpenAPI生成システム**: 計画段階（未実装）
- **Zodios自動生成**: 計画段階（未実装）  
- **現在のアプローチ**: 手動スキーマ定義 + Hono型推論
- **既存API**: users、posts、journals（新規追加）

### 2.3 対象プラットフォーム
- **Mobile**: React Native (Expo) パッケージ
- **Web**: 将来実装予定のWebアプリケーション
- **共通**: packages/client として独立パッケージ化

## 3. 機能要件

### 3.1 共通クライアント基盤機能
- **型安全性**: 全APIレスポンスとリクエストの完全な型チェック
- **バリデーション**: Zodスキーマによる実行時データ検証
- **エラーハンドリング**: 統一されたエラー処理
- **レスポンス解析**: `ApiResponse<T>`形式の適切な処理

### 3.2 ジャーナルAPIクライアント機能

#### 3.2.1 ジャーナル一覧取得
- **機能**: ページネーション・フィルタ対応の一覧取得
- **パラメータ**: 
  - `page?: number` (デフォルト: 1)
  - `limit?: number` (デフォルト: 10)
  - `authorId?: number` (作成者フィルタ)
  - `date?: string` (日付フィルタ、YYYY-MM-DD形式)
- **戻り値**: `Journal[]` + ページネーション情報

#### 3.2.2 ジャーナル詳細取得
- **機能**: 指定IDのジャーナル詳細取得
- **パラメータ**: `id: number`
- **戻り値**: `Journal`

#### 3.2.3 ジャーナル作成
- **機能**: 新規ジャーナルエントリ作成
- **パラメータ**: `CreateJournalInput`
- **戻り値**: 作成された`Journal`

#### 3.2.4 ジャーナル更新
- **機能**: 既存ジャーナルエントリの部分更新
- **パラメータ**: `id: number` + `UpdateJournalInput`
- **戻り値**: 更新された`Journal`

#### 3.2.5 ジャーナル削除
- **機能**: 指定IDのジャーナル削除
- **パラメータ**: `id: number`
- **戻り値**: 削除完了メッセージ

### 3.3 ユーザーAPIクライアント機能
- **ユーザー一覧取得**: ページネーション対応
- **ユーザー詳細取得**: ID指定取得
- **ユーザー作成**: 新規ユーザー登録
- **ユーザー更新**: 既存ユーザー情報更新
- **ユーザー削除**: ユーザーアカウント削除

### 3.4 投稿APIクライアント機能
- **投稿一覧取得**: ページネーション・フィルタ対応
- **投稿詳細取得**: ID指定取得
- **投稿作成**: 新規投稿作成
- **投稿更新**: 既存投稿編集
- **投稿削除**: 投稿削除

### 3.5 共通HTTP通信機能
- **ベースURL設定**: 環境に応じたAPI エンドポイント設定
- **認証ヘッダー**: 将来の認証機能に対応した設計
- **タイムアウト設定**: 適切なリクエストタイムアウト
- **リトライ機能**: ネットワークエラー時の自動リトライ
- **インターセプター**: リクエスト・レスポンス共通処理

### 3.6 エラーハンドリング
- **APIエラー**: `success: false`レスポンスの適切な処理
- **ネットワークエラー**: 通信失敗時のエラー処理
- **バリデーションエラー**: Zodスキーマバリデーション失敗時の処理
- **統一エラー型**: 一貫したエラーオブジェクト形式

## 4. 非機能要件

### 4.1 パフォーマンス
- **レスポンス時間**: 通常のCRUD操作で500ms以内
- **メモリ使用量**: モバイル・Web両方での効率的なメモリ使用
- **バンドルサイズ**: tree-shakingによる最適化
- **キャッシュ機能**: 適切なレスポンスキャッシュ

### 4.2 信頼性
- **型安全性**: コンパイル時およびランタイムでの型チェック
- **バリデーション**: 全APIレスポンスのスキーマ検証
- **エラー回復**: 適切なフォールバック処理
- **冪等性**: 冪等操作の適切な実装

### 4.3 保守性
- **スキーマ同期**: APIスキーマ変更時の自動的な型更新
- **テスタビリティ**: モック化可能な設計
- **ドキュメント**: 使用方法の明確な文書化
- **拡張性**: 新API追加時の最小限の変更

## 5. アーキテクチャ要件

### 5.1 ファイル配置
```
packages/client/
├── src/
│   ├── index.ts               # メインエクスポート
│   ├── api-client.ts          # 共通APIクライアント基盤
│   ├── services/
│   │   ├── journal-service.ts # ジャーナルAPIクライアント
│   │   ├── user-service.ts    # ユーザーAPIクライアント
│   │   └── post-service.ts    # 投稿APIクライアント
│   ├── types/
│   │   ├── api.ts             # API共通型定義
│   │   └── errors.ts          # エラー型定義
│   └── utils/
│       ├── validation.ts      # バリデーション実装
│       └── config.ts          # 設定管理
├── package.json
├── tsconfig.json
└── README.md
```

### 5.2 パッケージ構成
```json
{
  "name": "@soyokaze/client",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": "./dist/index.js",
    "./journals": "./dist/services/journal-service.js",
    "./users": "./dist/services/user-service.js",
    "./posts": "./dist/services/post-service.js"
  }
}
```

### 5.3 依存関係
- **既存パッケージ活用**: `@soyokaze/schemas` の型・スキーマを使用
- **Honoクライアント**: `hono/client` による型安全なHTTP通信
- **Zodバリデーション**: `zod` による実行時データ検証
- **API型定義**: Honoアプリケーションからの型推論

### 5.4 設計パターン
- **Service Layer Pattern**: ビジネスロジックとHTTP通信の分離
- **Factory Pattern**: APIクライアントインスタンス生成
- **Repository Pattern**: データアクセスの抽象化
- **Error-first Design**: エラーケースを最優先に考慮した設計

## 6. セキュリティ要件

### 6.1 データバリデーション
- **入力検証**: 全API呼び出しパラメータのZodバリデーション
- **出力検証**: 全APIレスポンスのスキーマ検証
- **XSS対策**: 適切なデータエスケープ
- **CSRF対策**: 必要に応じたCSRF保護

### 6.2 通信セキュリティ
- **HTTPS通信**: 全API通信でHTTPS使用
- **認証対応**: 将来のFirebase認証統合に対応した設計
- **機密情報保護**: APIキーやトークンの適切な管理
- **ヘッダー管理**: セキュリティヘッダーの適切な設定

## 7. 実装範囲

### 7.1 実装対象
- 共通APIクライアント基盤
- ジャーナルAPIクライアントサービス
- ユーザーAPIクライアントサービス
- 投稿APIクライアントサービス
- エラーハンドリング機能
- 型定義とバリデーション
- 設定管理機能
- 使用例とドキュメント

### 7.2 実装対象外（将来実装）
- OpenAPI仕様書自動生成
- Zodiosクライアント自動生成
- リアルタイム通信機能
- オフライン同期機能
- 包括的なテストスイート
- 詳細なキャッシュ機能

## 8. 使用方法

### 8.1 基本的な使用方法
```typescript
// Mobile/Webアプリケーションでの使用例
import { createApiClient } from '@soyokaze/client'

const apiClient = createApiClient({
  baseUrl: 'https://api.soyokaze.example.com',
  // 認証設定（将来実装）
})

// ジャーナル操作
const journals = await apiClient.journals.list({ page: 1, limit: 10 })
const journal = await apiClient.journals.create({
  title: 'My Journal',
  content: 'Today was a good day...',
  date: '2024-01-20',
  authorId: 1
})

// ユーザー操作
const users = await apiClient.users.list()
const user = await apiClient.users.getById(1)
```

### 8.2 個別サービス使用
```typescript
// 特定のサービスのみ使用
import { journalService } from '@soyokaze/client/journals'

const journals = await journalService.list({ authorId: 1 })
```

## 9. 互換性要件

### 9.1 既存システムとの統合
- **ローカルSQLite**: 既存のローカルデータベースとの共存
- **既存サービス**: Mobile版の`user-service.ts`と同様のAPIパターン
- **モノリポ構造**: 既存のワークスペース設定に準拠

### 9.2 将来拡張性
- **認証システム**: Firebase認証統合時の影響最小化
- **新API追加**: 容易な新エンドポイント追加
- **プラットフォーム対応**: Node.js、ブラウザ、React Native対応

## 10. 成功基準

### 10.1 機能的成功基準
- [ ] 全API（journals、users、posts）エンドポイントが呼び出し可能
- [ ] 型安全性が完全に保たれている
- [ ] Zodバリデーションが適切に機能している
- [ ] エラーハンドリングが統一的に動作している
- [ ] ページネーション・フィルタ機能が正常に動作している

### 10.2 技術的成功基準
- [ ] 既存の`@soyokaze/schemas`を100%活用している
- [ ] Honoクライアントによる型推論が正常に機能している
- [ ] Mobile・Web両方で実際に動作する
- [ ] 独立したnpmパッケージとして配布可能
- [ ] 将来の機能拡張に対応可能な設計である

### 10.3 使用性成功基準
- [ ] シンプルで直感的なAPI設計
- [ ] 包括的なドキュメント整備
- [ ] TypeScriptの補完が適切に機能する
- [ ] エラーメッセージが開発者にとって理解しやすい

## 11. 制約事項

### 11.1 技術的制約
- OpenAPI自動生成システムは使用しない（計画段階のため）
- Zodios自動生成は使用しない（未実装のため）
- 既存の手動スキーマ定義アプローチに従う

### 11.2 スコープ制約
- 認証機能は実装しない（将来対応の設計のみ）
- 包括的なテストは本実装範囲外
- 高度なキャッシュ機能は実装しない

この要件定義により、既存システムと整合性を保ちながら実用的な共通APIクライアントライブラリを効率的に実装できます。モバイルとWebの両方で使用可能な独立したパッケージとして、プロジェクト全体のAPI通信を統一的に管理できるようになります。